<?	function microtime_float()	{	    list($usec, $sec) = explode(" ", microtime());	    return ((float)$usec + (float)$sec);	}		require "smarty.lib.php";			$linkmysql->init();		// 取出2天後進行的活動	$sql  = "SELECT `a`.`aid`, `a`.`name`, `a`.`act_date`, `a`.`act_time`, `p`.`placename`, `t`.`tname` ";	$sql .= "FROM `activitie` a ";	$sql .= "LEFT JOIN `place` p ON `a`.`place` = `p`.`pid` ";	$sql .= "LEFT JOIN `topic` t ON `a`.`topic` = `t`.`tid` ";	$sql .= "WHERE `a`.`status` = 'OPEN' ";	$sql .= "AND TO_DAYS(`a`.`act_date`)-2 = TO_DAYS(NOW()) ";	$sql .= "ORDER BY `a`.`aid` DESC ";			$linkmysql->query($sql);		$actlist = array();		while ($data = mysql_fetch_array($linkmysql->listmysql))	{			array_push($actlist, $data);	}		$time_start = microtime_float();			foreach ($actlist as $act)	{		// 信件關於活動部分的資訊		$mailinfo = array();					$mailinfo["act_date"] = $act["act_date"];		$mailinfo["act_time"] = $act["act_time"];		$mailinfo["act_topic"] = $act["tname"];		$mailinfo["act_place"] = $act["placename"];		$mailinfo["act_name"] = $act["name"];			$aid = $act["aid"];				// 取出有登記活動的會員		$sql  = "SELECT `aj`.`charge_type`, `aj`.`charge_id`, `u`.`username`, `u`.`realname`, `u`.`email` ";		$sql .= "FROM `activitiejoin` aj ";		$sql .= "LEFT JOIN `user` u ON `aj`.`uid` = `u`.`uid` ";		$sql .= "WHERE `aj`.`aid` = '$aid' AND `aj`.`join_status` = 'join' ";		$sql .= "ORDER BY `u`.`sex` ASC, `aj`.`serial` ASC";				$linkmysql->query($sql);						$members = array();				while ($data = mysql_fetch_array($linkmysql->listmysql))		{			array_push($members, $data);		}				foreach ($members as $user)		{			if ($user["charge_type"] == "iBon")			{				$sql = sprintf("SELECT `pay_time` FROM `charge_ibon` WHERE `charge_ibon_id` = '%s'", $user["charge_id"]);				$linkmysql->query($sql);										list($pay_time) = mysql_fetch_array($linkmysql->listmysql);								if (!empty($pay_time)) 				{						// 信件關於會員部分的資訊					$mailinfo["realname"] = $user["realname"];																// 寄送會員活動提醒信					$iFMail->ActNotifyMail($user["email"], $user["username"], $mailinfo);										}			}			else if ($user["charge_type"] == "coupon")			{				// 信件關於會員部分的資訊				$mailinfo["realname"] = $user["realname"];													// 寄送會員活動提醒信				$iFMail->ActNotifyMail($user["email"], $user["username"], $mailinfo);			}		}	}		$linkmysql->close_mysql();		$time_end = microtime_float();	$time = $time_end - $time_start;		$fp = fopen ("/var/www/vhosts/ifriendxifun.net/httpdocs/log/UserNotify_log.txt", "a+");		fwrite($fp, date("Y-m-d H:i:s") . " Send User Notify Mail in $time seconds\n");	fclose($fp);		print date("Y-m-d H:i:s") . " Send User Notify Mail in $time seconds";?>